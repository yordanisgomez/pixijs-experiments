window.VIDEO_WIDTH=1920;window.VIDEO_HEIGHT=1080;const sndMng=new SoundMng;const renderer=PIXI.autoDetectRenderer({width:1920,height:1080,transparent:true});renderer.view.style.display="block";document.getElementById("container").appendChild(renderer.view);const loader=new PIXI.Loader;const stage=new PIXI.Container;const preloaderPath=getPreloaderResPath();const PreloaderBarForeground=PIXI.Sprite.from(preloaderPath+"LoadingBarBG.png");PreloaderBarForeground.x=1920/2-506/2;PreloaderBarForeground.y=900;stage.addChild(PreloaderBarForeground);const PreloaderBar=PIXI.Sprite.from(preloaderPath+"LoadingBar.png");PreloaderBar.x=1920/2-506/2+30;PreloaderBar.y=900;PreloaderBar.scale=new PIXI.Point(.01,1);stage.addChild(PreloaderBar);loader.onProgress.add(loader=>{const progress=loader.progress;PreloaderBar.scale.x=progress/100});loadResources(loader,onAssetsLoaded,sndMng);const ratio=1920/1080;resize=function(){var newWidth=window.innerWidth;var newHeight=window.innerHeight;var newWidthToHeight=newWidth/newHeight;if(newWidthToHeight>ratio){newWidth=newHeight*ratio;renderer.view.style.width=newWidth+"px";renderer.view.style.height=newHeight+"px"}else{newHeight=newWidth/ratio;renderer.view.style.width=newWidth+"px";renderer.view.style.height=newHeight+"px"}};let mainApp=null;function onAssetsLoaded(){mainApp=new Application({renderer:renderer,loader:loader,stage:stage},sndMng,resize);mainApp.init();stage.removeChild(PreloaderBar);stage.removeChild(PreloaderBarForeground);resize()}resize();window.onresize=(()=>{resize()});window.addEventListener("deviceorientation",()=>{resize()},true);function refresh(){renderer.render(stage);if(mainApp){mainApp.update(1)}requestAnimationFrame(refresh)}requestAnimationFrame(refresh);resize();const AppStates=Object.freeze({MAIN_MENU:0,GAME:1,ALARM:2});class Application{constructor(pixiApp,sndMng,resizeFnc){const appContainer=new PIXI.Container;const overContainer=new PIXI.Container;pixiApp.stage.addChild(appContainer);pixiApp.stage.addChild(overContainer);new FullScreenBtn(overContainer,{x:window.VIDEO_WIDTH-100,y:window.VIDEO_HEIGHT-100},resizeFnc);this.stateMap={[AppStates.MAIN_MENU]:new MainMenuApplet(this,appContainer,()=>{this.currentState=this.stateMap[AppStates.GAME];this.currentState.init()},sndMng),[AppStates.GAME]:new GameApplet(this,pixiApp,appContainer,sndMng),[AppStates.ALARM]:new AlarmApplet(this,appContainer)};this.currentState=this.stateMap[0]}init(){this.currentState.init()}update(delta){this.currentState.update(delta)}goToHome(){this.currentState=this.stateMap[0];this.init()}checkPortrait(){if(this.checkPortraitAlarm()){this.currentState=this.stateMap[AppStates.ALARM];this.currentState.init()}}checkPortraitAlarm(){if(this._isMobile()){if(this._isPortrait()){return true}}return false}_isMobile(){if(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)){return true}return false}_isPortrait(){if(window.matchMedia("(orientation: portrait)").matches){return true}return false}}class AlarmApplet{constructor(app,appContainer){this.appContainer=appContainer;this.app=app;this.alarmBox=new PIXI.Sprite(PIXI.Texture.from("LandScapeBox.png"));this.alarmBox.scale.set(4);this.alarmBox.x=1920/2-this.alarmBox.width/2;this.alarmBox.y=1080/2-this.alarmBox.height/2}init(){this.appContainer.addChild(this.alarmBox)}update(delta){if(this.app.checkPortraitAlarm()==false){this.appContainer.removeChild(this.alarmBox);this.app.goToHome()}}}class FullScreenBtn{constructor(parentContainer,pos,resizeFnc){this.resizeFnc=resizeFnc;this.btnUp=new Button(parentContainer,PIXI.Texture.from("fullScreenBtnUp.png"),pos,()=>{this.toggleFullScreen();this._setFullScreen(true)});this.btnDown=new Button(parentContainer,PIXI.Texture.from("fullScreenBtnDown.png"),pos,()=>{this.toggleFullScreen();this._setFullScreen(false)});this.btnDown.setVisible(false)}_setFullScreen(fullScreen){this.btnUp.setVisible(!fullScreen);this.btnDown.setVisible(fullScreen)}toggleFullScreen(){var doc=window.document;var docEl=doc.documentElement;window.SCREEN_TIPPED=true;if(this.isFullScreen()==false){window.FULL_SCREEN=true;window.FULL_SCREEN_DONE=true;var requestFullScreen=docEl.requestFullscreen||docEl.mozRequestFullScreen||docEl.webkitRequestFullScreen||docEl.msRequestFullscreen;if(requestFullScreen!=null)requestFullScreen.call(docEl)}else{window.FULL_SCREEN=false;var cancelFullScreen=doc.exitFullscreen||doc.mozCancelFullScreen||doc.webkitExitFullscreen||doc.msExitFullscreen;if(cancelFullScreen!=null)cancelFullScreen.call(doc)}this.resizeFnc()}isFullScreen(){var doc=window.document;if(!doc.fullscreenElement&&!doc.mozFullScreenElement&&!doc.webkitFullscreenElement&&!doc.msFullscreenElement){return false}return true}}class Congratulations{constructor(parentContainer,onHomeCallback,onMenuCallback){this.parentContainer=parentContainer;this.container=new PIXI.Container;this.container.visible=false;this.panel=new PIXI.Sprite(PIXI.Texture.from("congratulations.png"));this.panel.visible=false;this.container.addChild(this.panel);this.panelLose=new PIXI.Sprite(PIXI.Texture.from("congratulationsLose.png"));this.panelLose.visible=false;this.container.addChild(this.panelLose);this.homeBtn=new Button(this.container,PIXI.Texture.from("homeBtn.png"),{x:290,y:682},()=>{this.reset();onHomeCallback()});this.menuBtn=new Button(this.container,PIXI.Texture.from("menuBtn.png"),{x:443,y:683},()=>{this.reset();onMenuCallback()});this.container.x=1920/2-this.panel.width/2;this.container.y=1080/2-this.panel.height/2;this.scale={x:.1,y:.1};this.container.scale.set(this.scale.x,this.scale.y)}init(){this.parentContainer.addChild(this.container)}show(isWin=true){if(isWin){this.panel.visible=true}else{this.panelLose.visible=true}this.container.visible=true;dynamics.animate(this.scale,{x:1,y:1},{type:dynamics.spring,frequency:200,friction:200,duration:700,change:(el,prog)=>{this.container.scale.set(el.x,el.y)}})}reset(){this.panel.visible=false;this.panelLose.visible=false;this.container.visible=false;this.container.scale.set(.1);this.scale.x=.1;this.scale.y=.1}relink(){this.reset();this.parentContainer.removeChild(this.container);this.parentContainer.addChild(this.container)}}class Button{constructor(parentContainer,texture,pos,onTap,scale=1){this.spr=new PIXI.Sprite(texture);this.spr.scale.set(scale);this.spr.x=pos.x;this.spr.y=pos.y;parentContainer.addChild(this.spr);this.spr.interactive=true;this.spr.mouseup=onTap;this.spr.touchend=onTap;this.spr.mouseover=(()=>{this.spr.filters=[new PIXI.filters.GlowFilter(10,2,2,255,1)]});this.spr.mouseout=(()=>{this.spr.filters=null})}setVisible(visible){this.spr.visible=visible}setEnable(enable){this.spr.interactive=enable}}const CATALOG_AMOUNT=10;const CATALOG_HEALTHY_AMOUNT=7;const CATALOG_X_POS=1242;const CATALOG_Y_POS=13;const CATALOG_COLUMN_OFFSET=292;const CATALOG_ROW_OFFSET=213;const PLATE_POSITIONS=[{x:424,y:124},{x:604,y:280},{x:582,y:542},{x:260,y:542},{x:216,y:280}];const NUM_LIFES=2;const FOOD_MNG_STATE=Object.freeze({SELECTING_FOOD:0,EVALUATING_PLATE:1,MOVING_BACK:2,CONGRATULATIONS:3});class FoodMng{constructor(parentContainer,congratulationsRef,sndMng){this.sndMng=sndMng;this.congratulations=congratulationsRef;this.catalog={};this.parentContainer=parentContainer;this.selectedFood=[];this.state=FOOD_MNG_STATE.SELECTING_FOOD;this.lifes=NUM_LIFES}_nextPlatePosIndex(){let index=Object.values(this.platePosState).findIndex(value=>{return value});return index}init(){this.selectedFood=[];const typeFoodTextureCount={apple:4,meet:4,salad:6,frietPotatoe:2,sausage:1,fish:3,egg:4,dry:6,bread:4,sweet:8,boiled:5,beans:6,fruit:7};const randomFoodTypeTexture=type=>{const n=Math.floor(Math.random()*typeFoodTextureCount[type]+1);return PIXI.Texture.from(type+"0"+n.toString()+".png")};const healthyFood=[randomFoodTypeTexture("apple"),randomFoodTypeTexture("meet"),randomFoodTypeTexture("salad"),randomFoodTypeTexture("fish"),randomFoodTypeTexture("egg"),randomFoodTypeTexture("dry"),randomFoodTypeTexture("boiled"),randomFoodTypeTexture("beans"),randomFoodTypeTexture("fruit")];const unHealthyFood=[randomFoodTypeTexture("frietPotatoe"),randomFoodTypeTexture("sausage"),randomFoodTypeTexture("bread"),randomFoodTypeTexture("sweet")];healthyFood.sort((a,b)=>.5-Math.random());unHealthyFood.sort((a,b)=>.5-Math.random());const foodSelection=[];for(let i=0;i<CATALOG_AMOUNT;++i){let foodProp={texture:healthyFood[i],isHealthy:true};if(i>=CATALOG_HEALTHY_AMOUNT){foodProp={texture:unHealthyFood[i-CATALOG_HEALTHY_AMOUNT],isHealthy:false}}foodSelection.push(foodProp)}foodSelection.sort((a,b)=>.5-Math.random());let firstColumn=true;let row=0;let cnt=0;for(let i=0;i<CATALOG_AMOUNT;++i){this.catalog[i]=new Food(this.parentContainer,foodSelection[i].texture,{x:CATALOG_X_POS+(firstColumn?0:CATALOG_COLUMN_OFFSET),y:CATALOG_Y_POS+row*CATALOG_ROW_OFFSET},i,foodSelection[i].isHealthy,()=>{this._onTap(i)},this.sndMng);firstColumn=!firstColumn;cnt++;if(cnt==2){cnt=0;row++}}this.platePosState={0:true,1:true,2:true,3:true,4:true};Object.values(this.catalog).forEach(food=>{food.init()})}evaluatePlate(){const dangers=[];this.selectedFood.forEach(foodId=>{const food=this.catalog[foodId];if(!food.isHealthy){food.dangerEffect();dangers.push(food)}});if(dangers.length>0){this.lifes--;setTimeout(()=>{dangers.forEach(food=>{food.moveBack();this.platePosState[food.platePosIndex]=true;const index=this.selectedFood.indexOf(food.id);this.selectedFood.splice(index,1)});if(this.lifes<=0){this.block();this.congratulations.show(false);this.sndMng.play(SOUND.LOSE)}},2e3);this.sndMng.play(SOUND.BAD_FOOD)}else{this.block();this.congratulations.show(true);this.sndMng.play(SOUND.CONGRATULATION)}}reset(){Object.values(this.catalog).forEach(food=>{food.reset()});this.catalog={};this.lifes=NUM_LIFES}_onTap(foodId){const food=this.catalog[foodId];const posIndex=this._nextPlatePosIndex();if(posIndex!==-1){this.platePosState[posIndex]=false;this.selectedFood.push(foodId);this.sndMng.play(SOUND.SELECT_FOOD);let evaluateFnc=()=>{};if(this.selectedFood.length==PLATE_POSITIONS.length){evaluateFnc=(()=>{this.evaluatePlate()})}food.move(PLATE_POSITIONS[posIndex],evaluateFnc,posIndex)}}block(){Object.values(this.catalog).forEach(food=>{food.block()})}}class Food{constructor(parentContainer,texture,position,id,isHealthy,onTap,sndMng){this.sndMng=sndMng;this.parentContainer=parentContainer;this.id=id;this.isHealthy=isHealthy;this.position=position;this.spr=new PIXI.Sprite(texture);this.xScale=200/this.spr.width;this.yScale=200/this.spr.height;this.spr.scale.set(this.xScale,this.yScale);this.spr.x=position.x;this.spr.y=position.y;this.spr.interactive=true;this.spr.mouseup=onTap;this.spr.touchend=onTap;this.spr.mouseover=(()=>{this.spr.filters=[new PIXI.filters.GlowFilter(10,2,1,255,1)];this.sndMng.play(SOUND.OVER)});this.spr.mouseout=(()=>{this.spr.filters=null})}init(){this.parentContainer.addChild(this.spr)}move(pos,endCallback,platePosIndex){this.platePosIndex=platePosIndex;this.spr.interactive=false;this.spr.filters=null;dynamics.animate(this.spr,{x:pos.x,y:pos.y},{type:dynamics.spring,frequency:200,friction:200,duration:700,complete:endCallback,change:(el,progress)=>{const w=200/this.xScale;const h=200/this.yScale;const newScaleX=300/w;const newScaleY=300/h;const deltaScaleX=(newScaleX-this.xScale)*progress;const deltaScaleY=(newScaleY-this.yScale)*progress;el.scale.set(this.xScale+deltaScaleX,this.yScale+deltaScaleY)}})}moveBack(){dynamics.animate(this.spr,{x:this.position.x,y:this.position.y},{type:dynamics.spring,frequency:200,friction:200,duration:700,change:(el,progress)=>{const w=200/this.xScale;const h=200/this.yScale;const newScaleX=300/w;const newScaleY=300/h;const deltaScaleX=(newScaleX-this.xScale)*progress;const deltaScaleY=(newScaleY-this.yScale)*progress;el.scale.set(newScaleX-deltaScaleX,newScaleY-deltaScaleY)}})}dangerEffect(){this.spr.filters=[new PIXI.filters.GlowFilter(10,2,1,16711680,1)]}reset(){this.spr.visible=false;this.parentContainer.removeChild(this.spr)}block(){this.spr.interactive=false}}const PLAYER_POS=Object.freeze({LOCAL:0,BACK:1,LEFT:2,RIGHT:3});class GameApplet{constructor(applicationRef,app,appContainer,sndMng){this.appContainer=appContainer;this._onClick=this._onClick.bind(this);this.plate=new PIXI.Sprite(PIXI.Texture.from("plate06.png"));this.congratulations=new Congratulations(appContainer,()=>{this.reset();applicationRef.goToHome();sndMng.play(SOUND.CLICK)},()=>{this.menu.init();sndMng.play(SOUND.CLICK)});this.foodMng=new FoodMng(appContainer,this.congratulations,sndMng);const style=new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:32,fontStyle:"normal",fontWeight:"bold",fill:131202});this.menu=new Menu(appContainer,"MENU",[{obj:new PIXI.Text("Abandonar",style),onTap:()=>{this.reset();this.menu.cleanup();applicationRef.goToHome();sndMng.play(SOUND.CLICK)}},{obj:new PIXI.Text("Volver a jugar",style),onTap:()=>{this.menu.cleanup();this.foodMng.reset();this.foodMng.init();this.congratulations.relink();sndMng.play(SOUND.CLICK)}}],sndMng);this.appContainer.addChild(this.plate);this.plate.visible=false;this.menuBtn=new Button(this.appContainer,PIXI.Texture.from("menuBtn.png"),{x:30,y:1080-72-50},()=>{this.foodMng.block();this.menu.init();sndMng.play(SOUND.CLICK)},1.2);this.menuBtn.setVisible(false)}init(){this.plate.visible=true;this.foodMng.init();this.congratulations.init();this.menuBtn.setVisible(true)}_onClick(event){const{target:target}=event}update(delta){}reset(){this.foodMng.reset();this.plate.visible=false;this.menuBtn.setVisible(false)}}function loadResources(loader,onComplete,sndMng){sndMng.registerSounds("resources/audio/");loader.add("table","resources/stage/stage.json").add("Game_Font","resources/fonts/Verdana.ttf").add("btns","resources/buttons/buttons.json").add("food0","resources/food/food-0.json").add("food1","resources/food/food-1.json").load(onComplete)}function getPreloaderResPath(){return"resources/"}class MainMenuApplet{constructor(mainApp,appContainer,onGameSelectedCallback,sndMng){this.mainApp=mainApp;this.onGameSelectedCallback=onGameSelectedCallback;this.style=new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:32,fontStyle:"normal",fontWeight:"bold",fill:131202});this.menu=new Menu(appContainer,"MENU",[this._createMenuItemObj("Crear juego nuevo",()=>{this.menu.cleanup();this.background.visible=false;this.onGameSelectedCallback();sndMng.play(SOUND.CLICK)})],sndMng);this.background=new PIXI.Sprite(PIXI.Texture.from("bg04.jpeg"));appContainer.addChild(this.background);this.elapsed=0}init(){this.background.visible=true;this.menu.init()}update(delta){this.mainApp.checkPortrait()}_createMenuItemObj(text,onTapCallback){return{obj:new PIXI.Text(text,this.style),onTap:onTapCallback}}}class Menu{constructor(appContainer,title,itemsConfig,sndMng){this.sndMng=sndMng;this.appContainer=appContainer;this.box=new PIXI.Sprite(PIXI.Texture.from("menu.png"));this.box.x=1920/2-300;this.box.y=1080/2-200;this.tieleText=new PIXI.Text(title,new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:38,fontStyle:"normal",fontWeight:"bold",fill:131202}));this.tieleText.x=1920/2-this.tieleText.width/2;this.tieleText.y=1080/2-150;this.items=itemsConfig.map((config,i)=>{return this._addNewItem(config,i)})}init(){this.appContainer.addChild(this.box);this.appContainer.addChild(this.tieleText);this.items.forEach(item=>{this.appContainer.addChild(item)})}cleanup(){this.items.forEach(item=>{this.appContainer.removeChild(item)});this.appContainer.removeChild(this.tieleText);this.appContainer.removeChild(this.box)}updateItem(itemIndex,itemConfigObj){if(this.items.length<=itemIndex){const item=this._addNewItem(itemConfigObj,itemIndex);this.items.push(item);this.appContainer.addChild(item)}}_addNewItem(itemConfigObj,i){const{obj:obj,onTap:onTap}=itemConfigObj;obj.x=1920/2-obj.width/2;obj.y=1080/2-80+i*obj.height+(i==0?10:20);obj.interactive=true;obj.mouseup=onTap;obj.touchend=onTap;obj.mouseover=(()=>{obj.filters=[new PIXI.filters.GlowFilter(10,1,.5,255,1)];this.sndMng.play(SOUND.OVER)});obj.mouseout=(()=>{obj.filters=null});return obj}}