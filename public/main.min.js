const sndMng=new SoundMng;const app=new PIXI.Application({backgroundColor:1087931,width:1920,height:1080,resolution:window.devicePixelRatio||1});document.body.appendChild(app.view);const preloaderPath=getPreloaderResPath();const PreloaderBarForeground=PIXI.Sprite.from(preloaderPath+"LoadingBarBG.png");PreloaderBarForeground.x=1920/2-506/2;PreloaderBarForeground.y=900;app.stage.addChild(PreloaderBarForeground);const PreloaderBar=PIXI.Sprite.from(preloaderPath+"LoadingBar.png");PreloaderBar.x=1920/2-506/2+30;PreloaderBar.y=900;PreloaderBar.scale=new PIXI.Point(.01,1);app.stage.addChild(PreloaderBar);app.loader.onProgress.add(loader=>{const progress=loader.progress;PreloaderBar.scale.x=progress/100});loadResources(app.loader,onAssetsLoaded,sndMng);function onAssetsLoaded(){const mainApp=new Application(app,sndMng);mainApp.init();app.stage.removeChild(PreloaderBar);app.stage.removeChild(PreloaderBarForeground)}document.body.onresize=(()=>{scaleToWindow()});scaleToWindow=function(){const canvas=app.view;let scaleX,scaleY,scale,center;scaleX=window.innerWidth/canvas.offsetWidth;scaleY=window.innerHeight/canvas.offsetHeight;scale=Math.min(scaleX,scaleY);canvas.style.transformOrigin="0 0";canvas.style.transform="scale("+scale+")"};scaleToWindow();const AppStates=Object.freeze({MAIN_MENU:0,GAME:1});class Application{constructor(pixiApp,sndMng){this.stateMap={[AppStates.MAIN_MENU]:new MainMenuApplet(pixiApp,()=>{this.currentState=this.stateMap[AppStates.GAME];this.currentState.init()},sndMng),[AppStates.GAME]:new GameApplet(this,pixiApp,sndMng)};this.currentState=this.stateMap[0]}init(){this.currentState.init()}update(delta){this.currentState.update(delta)}goToHome(){this.currentState=this.stateMap[0];this.init()}}class Congratulations{constructor(app,parentContainer,onHomeCallback,onMenuCallback){this.parentContainer=parentContainer;this.app=app;this.container=new PIXI.Container;this.container.visible=false;this.panel=new PIXI.Sprite(PIXI.Texture.from("congratulations.png"));this.panel.visible=false;this.container.addChild(this.panel);this.panelLose=new PIXI.Sprite(PIXI.Texture.from("congratulationsLose.png"));this.panelLose.visible=false;this.container.addChild(this.panelLose);this.homeBtn=new Button(this.container,PIXI.Texture.from("homeBtn.png"),{x:290,y:682},()=>{this.reset();onHomeCallback()});this.menuBtn=new Button(this.container,PIXI.Texture.from("menuBtn.png"),{x:443,y:683},()=>{this.reset();onMenuCallback()});this.container.x=1920/2-this.panel.width/2;this.container.y=1080/2-this.panel.height/2;this.scale={x:.1,y:.1};this.container.scale.set(this.scale.x,this.scale.y)}init(){this.parentContainer.addChild(this.container)}show(isWin=true){if(isWin){this.panel.visible=true}else{this.panelLose.visible=true}this.container.visible=true;dynamics.animate(this.scale,{x:1,y:1},{type:dynamics.spring,frequency:200,friction:200,duration:700,change:(el,prog)=>{this.container.scale.set(el.x,el.y)}})}reset(){this.panel.visible=false;this.panelLose.visible=false;this.container.visible=false;this.container.scale.set(.1)}relink(){this.reset();this.parentContainer.removeChild(this.container);this.parentContainer.addChild(this.container)}}class Button{constructor(parentContainer,texture,pos,onTap,scale=1){this.spr=new PIXI.Sprite(texture);this.spr.scale.set(scale);this.spr.x=pos.x;this.spr.y=pos.y;parentContainer.addChild(this.spr);this.spr.interactive=true;this.spr.mouseup=onTap;this.spr.touchend=onTap;this.spr.mouseover=(()=>{this.spr.filters=[new PIXI.filters.GlowFilter(10,2,2,255,1)]});this.spr.mouseout=(()=>{this.spr.filters=null})}setVisible(visible){this.spr.visible=visible}}const CATALOG_AMOUNT=10;const CATALOG_HEALTHY_AMOUNT=7;const CATALOG_X_POS=1242;const CATALOG_Y_POS=13;const CATALOG_COLUMN_OFFSET=292;const CATALOG_ROW_OFFSET=213;const PLATE_POSITIONS=[{x:474,y:174},{x:654,y:330},{x:632,y:592},{x:310,y:592},{x:266,y:330}];const NUM_LIFES=2;const FOOD_MNG_STATE=Object.freeze({SELECTING_FOOD:0,EVALUATING_PLATE:1,MOVING_BACK:2,CONGRATULATIONS:3});class FoodMng{constructor(app,parentContainer,congratulationsRef,sndMng){this.sndMng=sndMng;this.congratulations=congratulationsRef;this.catalog={};this.parentContainer=parentContainer;this.selectedFood=[];this.state=FOOD_MNG_STATE.SELECTING_FOOD;this.lifes=NUM_LIFES}_nextPlatePosIndex(){let index=Object.values(this.platePosState).findIndex(value=>{return value});return index}init(){this.selectedFood=[];const typeFoodTextureCount={apple:4,meet:4,salad:6,frietPotatoe:2,sausage:1,fish:3,egg:4,dry:6,bread:4,sweet:8,boiled:5,beans:6,fruit:7};const randomFoodTypeTexture=type=>{const n=Math.floor(Math.random()*typeFoodTextureCount[type]+1);return PIXI.Texture.from(type+"0"+n.toString()+".png")};const healthyFood=[randomFoodTypeTexture("apple"),randomFoodTypeTexture("meet"),randomFoodTypeTexture("salad"),randomFoodTypeTexture("fish"),randomFoodTypeTexture("egg"),randomFoodTypeTexture("dry"),randomFoodTypeTexture("boiled"),randomFoodTypeTexture("beans"),randomFoodTypeTexture("fruit")];const unHealthyFood=[randomFoodTypeTexture("frietPotatoe"),randomFoodTypeTexture("sausage"),randomFoodTypeTexture("bread"),randomFoodTypeTexture("sweet")];healthyFood.sort((a,b)=>.5-Math.random());unHealthyFood.sort((a,b)=>.5-Math.random());const foodSelection=[];for(let i=0;i<CATALOG_AMOUNT;++i){let foodProp={texture:healthyFood[i],isHealthy:true};if(i>=CATALOG_HEALTHY_AMOUNT){foodProp={texture:unHealthyFood[i-CATALOG_HEALTHY_AMOUNT],isHealthy:false}}foodSelection.push(foodProp)}foodSelection.sort((a,b)=>.5-Math.random());let firstColumn=true;let row=0;let cnt=0;for(let i=0;i<CATALOG_AMOUNT;++i){this.catalog[i]=new Food(this.parentContainer,foodSelection[i].texture,{x:CATALOG_X_POS+(firstColumn?0:CATALOG_COLUMN_OFFSET),y:CATALOG_Y_POS+row*CATALOG_ROW_OFFSET},i,foodSelection[i].isHealthy,()=>{this._onTap(i)},this.sndMng);firstColumn=!firstColumn;cnt++;if(cnt==2){cnt=0;row++}}this.platePosState={0:true,1:true,2:true,3:true,4:true};Object.values(this.catalog).forEach(food=>{food.init()})}evaluatePlate(){const dangers=[];this.selectedFood.forEach(foodId=>{const food=this.catalog[foodId];if(!food.isHealthy){food.dangerEffect();dangers.push(food)}});if(dangers.length>0){this.lifes--;setTimeout(()=>{dangers.forEach(food=>{food.moveBack();this.platePosState[food.platePosIndex]=true;const index=this.selectedFood.indexOf(food.id);this.selectedFood.splice(index,1)});if(this.lifes<=0){this.congratulations.show(false);this.sndMng.play(SOUND.LOSE)}},2e3);this.sndMng.play(SOUND.BAD_FOOD)}else{this.congratulations.show(true);this.sndMng.play(SOUND.CONGRATULATION)}}reset(){Object.values(this.catalog).forEach(food=>{food.reset()});this.catalog={};this.lifes=NUM_LIFES}_onTap(foodId){const food=this.catalog[foodId];const posIndex=this._nextPlatePosIndex();if(posIndex!==-1){this.platePosState[posIndex]=false;this.selectedFood.push(foodId);this.sndMng.play(SOUND.SELECT_FOOD);let evaluateFnc=()=>{};if(this.selectedFood.length==PLATE_POSITIONS.length){evaluateFnc=(()=>{this.evaluatePlate()})}food.move(PLATE_POSITIONS[posIndex],evaluateFnc,posIndex)}}}class Food{constructor(parentContainer,texture,position,id,isHealthy,onTap,sndMng){this.sndMng=sndMng;this.parentContainer=parentContainer;this.id=id;this.isHealthy=isHealthy;this.position=position;this.spr=new PIXI.Sprite(texture);const xScale=200/this.spr.width;const yScale=200/this.spr.height;this.spr.scale.set(xScale,yScale);this.spr.x=position.x;this.spr.y=position.y;this.spr.interactive=true;this.spr.mouseup=onTap;this.spr.touchend=onTap;this.spr.mouseover=(()=>{this.spr.filters=[new PIXI.filters.GlowFilter(10,2,1,255,1)];this.sndMng.play(SOUND.OVER)});this.spr.mouseout=(()=>{this.spr.filters=null})}init(){this.parentContainer.addChild(this.spr)}move(pos,endCallback,platePosIndex){this.platePosIndex=platePosIndex;this.spr.interactive=false;this.spr.filters=null;dynamics.animate(this.spr,{x:pos.x,y:pos.y},{type:dynamics.spring,frequency:200,friction:200,duration:700,complete:endCallback})}moveBack(){dynamics.animate(this.spr,{x:this.position.x,y:this.position.y},{type:dynamics.spring,frequency:200,friction:200,duration:700})}dangerEffect(){this.spr.filters=[new PIXI.filters.GlowFilter(10,2,1,16711680,1)]}reset(){this.spr.visible=false;this.parentContainer.removeChild(this.spr)}}const PLAYER_POS=Object.freeze({LOCAL:0,BACK:1,LEFT:2,RIGHT:3});class GameApplet{constructor(applicationRef,app,sndMng){this.sndMng=sndMng;this.applicationRef=applicationRef;this.pixiApp=app;this._onClick=this._onClick.bind(this);this.plate=new PIXI.Sprite(PIXI.Texture.from("plate06.png"));this.congratulations=new Congratulations(app,app.stage,()=>{this.reset();applicationRef.goToHome();sndMng.play(SOUND.CLICK)},()=>{this.menu.init();sndMng.play(SOUND.CLICK)});this.foodMng=new FoodMng(app,app.stage,this.congratulations,sndMng);const style=new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:32,fontStyle:"normal",fontWeight:"bold",fill:131202});this.menu=new Menu(app,"MENU",[{obj:new PIXI.Text("Abandonar",style),onTap:()=>{this.reset();this.menu.cleanup();applicationRef.goToHome();sndMng.play(SOUND.CLICK)}},{obj:new PIXI.Text("Volver a jugar",style),onTap:()=>{this.menu.cleanup();this.foodMng.reset();this.foodMng.init();this.congratulations.relink();sndMng.play(SOUND.CLICK)}}],sndMng);this.pixiApp.stage.addChild(this.plate);this.plate.visible=false;this.menuBtn=new Button(this.pixiApp.stage,PIXI.Texture.from("menuBtn.png"),{x:30,y:1080-72-50},()=>{this.menu.init();sndMng.play(SOUND.CLICK)},1.2);this.menuBtn.setVisible(false)}init(){this.plate.visible=true;this.foodMng.init();this.congratulations.init();this.menuBtn.setVisible(true)}_onClick(event){const{target:target}=event}update(delta){}reset(){this.foodMng.reset();this.plate.visible=false;this.menuBtn.setVisible(false)}}function loadResources(loader,onComplete,sndMng){sndMng.registerSounds("resources/audio/");loader.add("table","resources/stage/stage.json").add("Game_Font","resources/fonts/Verdana.ttf").add("btns","resources/buttons/buttons.json").add("food0","resources/food/food-0.json").add("food1","resources/food/food-1.json").load(onComplete)}function getPreloaderResPath(){return"resources/"}class MainMenuApplet{constructor(app,onGameSelectedCallback,sndMng){this.onGameSelectedCallback=onGameSelectedCallback;this.style=new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:32,fontStyle:"normal",fontWeight:"bold",fill:131202});this.menu=new Menu(app,"MENU",[this._createMenuItemObj("Crear juego nuevo",()=>{this.menu.cleanup();this.background.visible=false;this.onGameSelectedCallback();sndMng.play(SOUND.CLICK)})],sndMng);this.background=new PIXI.Sprite(PIXI.Texture.from("bg04.jpeg"));app.stage.addChild(this.background);this.loading=new PIXI.Text("Loading...",new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:36,fontStyle:"normal",fontWeight:"bold",fill:3604659}));this.loading.visible=false;this.loading.x=app.screen.width/2-this.loading.width/2;this.loading.y=app.screen.height/2;app.stage.addChild(this.loading);this.elapsed=0}init(){this.background.visible=true;this.menu.init()}update(delta){if(this.loading.visible){this.elapsed+=.1;this.loading.alpha=Math.cos(this.elapsed);if(this.elapsed>Math.PI*2){this.elapsed=0}}}_createMenuItemObj(text,onTapCallback){return{obj:new PIXI.Text(text,this.style),onTap:onTapCallback}}}class Menu{constructor(app,title,itemsConfig,sndMng){this.sndMng=sndMng;this.app=app;this.box=new PIXI.Sprite(PIXI.Texture.from("menu.png"));this.box.x=app.screen.width/2-300;this.box.y=app.screen.height/2-200;this.tieleText=new PIXI.Text(title,new PIXI.TextStyle({fontFamily:"Game_Font",fontSize:38,fontStyle:"normal",fontWeight:"bold",fill:131202}));this.tieleText.x=app.screen.width/2-this.tieleText.width/2;this.tieleText.y=app.screen.height/2-150;this.items=itemsConfig.map((config,i)=>{return this._addNewItem(config,i)})}init(){this.app.stage.addChild(this.box);this.app.stage.addChild(this.tieleText);this.items.forEach(item=>{this.app.stage.addChild(item)})}cleanup(){this.items.forEach(item=>{this.app.stage.removeChild(item)});app.stage.removeChild(this.tieleText);app.stage.removeChild(this.box)}updateItem(itemIndex,itemConfigObj){if(this.items.length<=itemIndex){const item=this._addNewItem(itemConfigObj,itemIndex);this.items.push(item);this.app.stage.addChild(item)}}_addNewItem(itemConfigObj,i){const{obj:obj,onTap:onTap}=itemConfigObj;obj.x=this.app.screen.width/2-obj.width/2;obj.y=this.app.screen.height/2-80+i*obj.height+(i==0?10:20);obj.interactive=true;obj.mouseup=onTap;obj.touchend=onTap;obj.mouseover=(()=>{obj.filters=[new PIXI.filters.GlowFilter(10,1,.5,255,1)];this.sndMng.play(SOUND.OVER)});obj.mouseout=(()=>{obj.filters=null});return obj}}